import { cert } from "./config.js"

//const {cert} = require("./config.js")
class Client {
  
  constructor(sites, log) {
    this.sites = sites; 
    this.log = console.log.bind(console)
  }

  async logStorageUpdate(changes) {
    const updatedItems = Object.keys(changes)
    for (const item of updatedItems) {
      console.log(`${item} has changed value from ${changes[item].oldValue}`)
    }
  }

  static getCertificateFromStorage(serialNumber) {
    // returns cert object
    try {
      return browser.storage.local.get(serialNumber)
    } 
    catch (error) {
      this.log(error)
      return 0
    }
  }

  parseCertificate(securityInfo) {
    var cert = securityInfo.certificates[0]
    var subjectString = cert.subject.split('=')
    var certInfo = {
      SerialNumber: cert.serialNumber,
      Subject: {
        Organization: subjectString[2].substring(1, subjectString[2].length - 3),
        CommonName: subjectString[1].substring(0, subjectString[1].length- 2),
        Country: subjectString[5]
      },
      Validity: { Start: new Date(cert.validity.start), End: new Date(cert.validity.end) },
      IsCA: true,
      KeyUsage: "",
      ExtKeyUsage: "",
      BasicConstraintsValid: true
    }

    this.log(certInfo)

    try {
      this.storeCertificate(certInfo)
    } 
    catch (error) {
      this.log(error)
      return 0
    }
    return certInfo
  }

  async storeCertificate(data) {
    // returns status (1 if successfully stored)
    this.log("In store cert func")
    // currently storing as a serial number: certInfo pair
    // idk if this is final for the key
    if (! this.isCertificateStored(data.SerialNumber)) {
      browser.storage.local.set({[data.SerialNumber]: data}).then(this.log("Storage set!"))
      return 1
    }
    return 0
  }

  isCertificateStored(serialNumber) {
    try {
      browser.storage.local.get(serialNumber)
    }
    catch (error) {
      return false
    }
    return true
  }

  static deleteCertificateFromStorage() {
    // returns status
  }

  storeCertObject() {
    var cert = {
      "Issuer": "localhost:9100",
      "Serial Number": "fe:a8:5e:a5:cc:5d:84:7c:99:e6:77:b2:9d:80:a7:81",
      "Signature Algorithm": "sha256WithRSAEncryption",
      "Validity": {
        "Not Before": "Mar 13 21:59:29 2023 GMT",
        "Not After": "Mar 12 21:59:29 2024 GMT"
      },
      "Subject": "CN = Testing Dummy 0",
      "STH": {
        "application": "CTng",
        "period": "0",
        "type": "http://ctng.uconn.edu/101",
        "signer": "localhost:9000",
        "signers": null,
        "signature": [
          "{\"sig\":\"6a28a6947cf43ac670e6fe52cdc6c98dae9c585b8ba8e7df8965991c7ae9fbaa595cd39b551adc035fa8bad3465aae8fbaf824bec05d2d8c18b23833e35ee383aa91d6c6c67abe2a2a9ff9c7e2b2f0b84bcf15ff7bdd3ed89379b0b310b6566e4b2b50db4820a96e865258529ea41d017557cd5602a4aa095a521dafc0e0a43b1753b7ae8fde64e07e901679608246e3a9b691c3a072a222b4f31c2d6f091419c586e17661ce22306e392c4e03b7aff641aadc281b037cd232ad6a7cc58c4f9ccddff0df10276d6a1028a22734c449b433f7857f7e78782b77645a5c4df86758f3c85573dc7413af66b56240450b6fb37a6b5adac45e18a606c96a6cbd5e6e59\",\"id\":\"localhost:9000\"}",
          ""
        ],
        "timestamp": "2023-03-13T21:59:31Z",
        "crypto_scheme": "RSA",
        "payload": [
          "localhost:9000",
          "{\"Signer\":\"localhost:9000\",\"Timestamp\":\"2023-03-13T21:59:31Z\",\"RootHash\":\"\\ufffd\\ufffd\\u0010\\ufffd'@Gj\\ufffd*\\ufffdqy...\\ufffdb\\u0013\\ufffd\\n\\ufffd\\ufffd?\\ufffd\\ufffd\\ufffd\\ufffd7\\ufffd\\u001d\\ufffd\",\"TreeSize\":12}",
          ""
        ]
      },
      "POI": {
        "SiblingHashes": [
          "Z7iPVPvZQRYWQuDiaPx5bX3crrwOIk9DpVBk6+2gTvw=",
          "a3JZsStg1xHaXfl6PT7QJZ34IIu7dAXjxr9gMO6TNao=",
          "vqAdBXLKvmVVxOaa+GAYlIuTouUTdi+mR/7Ahi96rGA=",
          "CuSdi9Auz5Uc9d42sl6A+trdIqOQzsH0emfED4q6aqs="
        ],
        "NeighborHash": "6gkaYIt1zM4paSWBI34pJdtIWCoCKyYACEODqkuSyCM="
      }
    }
    var pubK = {
      "localhost:8080": {
        "N": 26662804590643791677072420283015760587154157689605758379851514719978215919521412275737378885372083550411882040376077309761261484106214413033460894746877699324502479463230801695576355786865962140694202973691474123823321191258646836707477909182205447437076192587695438239613061024503577254884843896577068040920791905775746148630212163280965168760538339740807571761811895131523126047043418963457662633770919926265619061187002884302414655744205957559232712028110168938083940564931189422013050907554982057611826141444604099721487636098145869054765536197456663820722806366750245090144679903197197623431235455716208809440731,
        "E": 65537,
        "T": "Q1iDxa22C5zUkaPlwlPxAEfX9zVRGeWCiGpPHXLa2bXwKHedmgeuLr49TLCsv7kQtXDCJmEud7Voue3YeTspVdoIG+dpsf+HlvFOopj8EKcMicEU746EhnF6qjq0TTCZ"
       },
       "localhost:8081": {
        "N": 24280176308031386921173733687232493878754252026368349040299953253175242700899869480251465643403988588824547433327357468226125020019908195217564511089513051811661233425866002102617610644288962587405424780253893290280399799501217621196225465658191868859593816558054238847046131655224277019243234148873516642901071323186569584299376971733855897024955412021876872347613597163123887779534365562807667681612628513317700667396844607836521524051343478816080419422424092581398909791727616434632305657066699373948569116545960449968602350947816558393265189050792122551036716068671340837998330234033779091502825679424981091805559,
         "E": 65537,
        "T": "he1xm8H3B8g++SwuvSLwCqcETS/dYGS9xZzInd8L4ZiFLNb3FWRB/wh9R+aWbeYMBECBB9eJG88aWasT+pGfj2qcOMEK5vFhQjTg0VMPbkr1c5U41rpofDklaqQRipQV"
       },
       "localhost:8082": {
        "N": 23016576822245162688783535122254152338103888080343531749282321381643967688582954861127888482316802088696866308671755854604112605080623344129296973926373141789288618773665327825423959362583486491053945162742740319682641431778204933382263780105076444882323661141512703563621385144332588074922669543931567383752416514546494583210644460835401520730544906916991032827099382650778552196112699964502715274819550766693822190514590905001847503890213169545115742293357334789308206864436285419032853332723497368237467797280590697114177784687679685252903623335238534220566409714903022531362604971144767394632835626558114209499121,
         "E": 65537,
        "T": "eU9Qc6q2xU+avHCP3YE1k7HhyvSFYXwh2fYRqTwilZ3sNsKo9fI/eQ2xqnTvB84C2gQOzi0KxUDiYGNDhoQYEu535w9HbCrQ27ruG1Kc/9VG75+jRqHuYFXGGJmCQWoQ"
       },
       "localhost:8083": {
        "N": 20229031691404897809408002767307893706768082521426711278437575120686191044593774684167366394721177318247950276850410791788120462060618256552764278875580783779752821241895362830709827824502328473083082433538268539442559862362441210602379468924372690266794412916523419052257204270890260299405355838363511231866225731848735267682318419040313108882220236711192500344957217275786677648723561521675410331591961944370677618075653856543136142764485018226028533368371430059368601470101281809019639956008664462352827261476195072162275429425459592445777339534934837856010046903953136760418370228228676589215878369211808787482333,
         "E": 65537,
         "T": "pXWTiwSYmuXFRjBLb2VxqE/WZmrRJhCOh2vOsuApWIwOyhuuv4eleZ0/31AF6DYEVtvP6U6BQau73cb3ovhRfaXL8i/xEI+6JadV/BSPuKC4VyVnkMjMHAiUxjHyZJgV"
       },
       "localhost:8180": {
        "N": 25698811276054591862282609590757339876015456172913769075241593242461980317733410617033295388497994333428525906765630883930954306787302301454399783485610617238448084668024133317134100642165476907226851624364740843259515429685045125324673862962672127770527787573225628307229156419230571106367027424683953699994589089735558210504515500786974923830854584913404144016324237911146423708624476750955419001767500196047672515478258063154648788743847230735024502324726583518734154326229377197977022644250510757697287719101156203825565406621885137186048490247242454872007054208587462505385290261198083884050687791509041380670657,
        "E": 65537
       },
       "localhost:8181": {
        "N": 25953447243468784159472156267200930215116474064331400649523276646638936182099446759985876578649742936902282719276401606791117841165620874014100663195710552760293965550100059445407155205778527237385405463963576739781333852502573363325451093447879019265125524380788436848934094446759578099237621488401531290313068769918228260773416458090221310107499561531972828195948300714060740217856479855856675324460676169982077588711054012671039366601773327690535100097632195089709888393510105171866541011180911052376460744990423601983177077994862632279743029355451395460856278043136964977496288858994156602618794868318462470475381,
        "E": 65537
       },
       "localhost:8182": {
        "N": 26295507656148265032378411804903614116108427069439401675842764939716575728573782061276066150842020318115884092270452974035620910858820336747738091022824664060273933769032274495844197490499652822513088448115576142163959666909103584459286286517674961295411431018535631007561938816957538911915100690171477335806139312341220119073335480914069427999232360925380085427195017216582009590627149277243228926564798390839227056756671802651035808240339841234596072708554149105038631337300762100806020473781145928348079781439736457043922399040154189171346370882424451392199078115056481903666355496312909182571108582478343726415079,
        "E": 65537
       },
       "localhost:8183": {
        "N": 23618480099978458871754353592347401875022311693283382190758147770578643188042532467880149639232189840409928934955516693629993324731934581450350726357200251455887216167352909301415001450192572373452156202471371021623184059541863843182264182600986643746279429601040964870332223015869012471947910999299090349469755942682194598524057114181386681559812114684123112043273505374697427945533954134216254178118608033417378487818113291093257221479449555436897251220809295879724765287598848804726128183592058704265360544187077112863495679046264222166076972364081356129509825621976387055959150684709191831139291827653832059779359,
        "E": 65537
       },
       "localhost:9000": {
        "N": 22563152875487429106689137614824193881384868606949072613876077246817826800656408428689569792626425751757103668905790874085904308994272577249393839901594638373026083729614957772225986980106530492907313646509054189167540885492731964740591279266611759417376789694996801929389724110452859432030423682537555131205369172007786755802263956544307456888475975019812997965673565517315450787068915058834733994299513295847005782966188263824821362702920674845139389611962806159634284684262824406319009282688892418677305894992319953420121246560164710149855635006516385593897453237579149710587187652820590321935200528151126709040649,
        "E": 65537
       },
       "localhost:9001": {
        "N": 25744805696734757660807513232119781823927491679894589128304550467001049066677965138201992877653337101627859947311520760473089191876788604050953173399532314865369285589210206752462448634241396217244436514496187982953466645078394515557412634770927393090624518060550981714545293008717726449443111946429203004882115892280373004185734546196374154794624354220769083034915678820855188090639605824191650551016054232208404792411986527219754181914749578461327830809632169920163520178302515247605742105388131142576014102375308808347659680920404956890291767929326097070857414469444259099894174515035429636894393597656925304748987,
        "E": 65537
       },
       "localhost:9002": {
        "N": 22289390915050203806588517454800325457216908559672523812405561798101539890695837337394073850376648078710534021593376357220873539409701710020931651455770440565854662145330464804596814303830056909568999490539396406142661649163679245609360255632859554387025755403992548033030570879604706862757605364665278732688055458662538225982555390543287977136623684135296631986158901627962438507434279513954742970023680697752627945317409577737827751048171261761635883871479061679756473327915532392443747301970259376865728344587796539952524157512158481970520010756283057730235990638807711293576156678311814066831602914661317454874523,
        "E": 65537
       },
       "localhost:9100": {
        "N": 28289144454339349066815611011072919704815780568116807124033317074501747158092238108625845484294458170684635180767779471186812062223165047836555517729612627445913894917126907141539096933580451852414255077776299604189818614081401604468933933073559526635896880884676597663249511990732549694181080063376692648852496681384390051520215961439588026093668116084970297892897465409342405204800861401311876470541382798878546753983480412864678228738921800842175374768234701021535062817797558477630046686713237936988594016657525936313108624708966744718176337912405211276765633214282274543820269348549015966681790731369304710454687,
        "E": 65537
       },
       "localhost:9101": {
        "N": 29076656325036407040562952390872062161139629135434731152856820015733880738060419549609757186342875526697106306194175286989839088521399889673859013158277906569330860375176434699841962278750946414698481089942230405827288462138351513926383576235238673913639972830397567757380272367799866671874798623339695750993844042442350041358554390195543590093916135426540004835460538002170790281792351539220063526334742887175482193814664732782660478054860699632360499141218949004627919141782234223545036644887779122012660205146565905551412057549307708783956660703329832784809159046697338153153337943130372676611226112425585533065321,
        "E": 65537
       },
       "localhost:9102": {
        "N": 19535546192949020531643233518736619640970965177249254128403592488241847011809756610315760702178301364559972869462531328195084141407075597803401548000651289154328846828887651020188641824231896783350444548320066261221054504369901291975434374376549866081519714312502090737401506684783657987522380781034061555129895678729569059141495526416983684925433967032419955559681076992670800972487955378751004425966061482099254720814081394221046593707605157978389084783748206802445272554822376077169079654515395870728091932252612048640400125773712939833387281478454830671087251933865489816639496544252766241043959569631003740557263,
        "E": 65537
      },
      "RSAPrivateKey": {
        "N": 28289144454339349066815611011072919704815780568116807124033317074501747158092238108625845484294458170684635180767779471186812062223165047836555517729612627445913894917126907141539096933580451852414255077776299604189818614081401604468933933073559526635896880884676597663249511990732549694181080063376692648852496681384390051520215961439588026093668116084970297892897465409342405204800861401311876470541382798878546753983480412864678228738921800842175374768234701021535062817797558477630046686713237936988594016657525936313108624708966744718176337912405211276765633214282274543820269348549015966681790731369304710454687,
        "E": 65537,
        "D": 24286871732355821524396605788150477244784776441782384802992730597934614093566378949018618431936580694471382554067154614131345357294145008415456859561112874914084338579918907339650842866898151021195478309215916157738989339171613916954461872596912076631044112531491047309500492731717455918688656327965723360661409567093078590271537464668955146101384814196414274491562078875534696277994171275660677462197388750839372144151280860156202741744143705002332400462779772245556214518757183846260776821913408860023474747322470477199150095505019512817170312401070658636096928247054933113372758347645651936577518923998992335837993,
        "Primes": [
         168829081367707509553610792215063341400730245924170434642310270987810659274133958712980948433651300383158806671355192199737658839933012242725264269462535985696766592712159409090780105261167771237010138586551620576620502634143397900641341292327808744675921718937648918217582899519091360328300070007358223913589,
         167560850448069228368725445039124486090249644424207839424550619276706160724381350126242561296743023177518362112756274925012389223863115539148705911032043580990386673573987751870066713368197839094541942315660218798770183585310082594680810823774767589694183431233026026364963818093230552012766272805615539881283
        ],
        "Precomputed": {
         "Dp": 61146025532812082438386037871992057486423441983247775099102439723616793697161048629191384897403714938045034639231073165585441357166943537136684204342016786799799378131678528681184011756398343196693053534497906007395276721913235158301766588563603283086312738158658997555770750919101462208409455142814819152737,
         "Dq": 2937690421667631160957406294916673551088649792383154668337102118634288702142517528953914627309119026366306026634679034573435390973323767558506844862838062080320342523101636127663863980042713537690597551317478544940826417741448111773322728176712512940150094793578389372314012344006010410343293825680947484987,
         "Qinv": 101130578022651400459186069529070516823791774043672720894797485239741146271197829800949570239710662804910275330647237538856543116531130488011834112972917410435879460797294785201656729324181672068916979233275687023287092742979781355544651976994959744899470147903577020715916848679095875613837128312314719352511,
         "CRTValues": []
        }
       }
    }
    browser.storage.local.set({ cert });
    browser.storage.local.set({pubK});
  }

}

export { Client };
